<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>501 Dart Counter</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #080810; --surface: #10101c; --border: #1c1c30;
    --accent: #f0c040; --red: #e84a4a; --green: #3de88a;
    --text: #e8e8f2; --muted: #44445a;
  }
  body {
    font-family: 'Rajdhani', sans-serif;
    background: var(--bg); color: var(--text);
    min-height: 100vh; display: flex; flex-direction: column;
    align-items: center; justify-content: center; padding: 1.5rem;
    background-image:
      radial-gradient(ellipse 60% 50% at 15% 15%, rgba(240,192,64,0.05) 0%, transparent 100%),
      radial-gradient(ellipse 60% 50% at 85% 85%, rgba(232,74,74,0.05) 0%, transparent 100%);
  }
  h1.logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(3rem, 10vw, 5.5rem); letter-spacing: 0.18em;
    color: var(--accent); text-shadow: 0 0 60px rgba(240,192,64,0.25);
    line-height: 1; text-align: center;
  }
  .tagline { text-align: center; color: var(--muted); font-size: 0.78rem; letter-spacing: 0.3em; text-transform: uppercase; margin-top: 0.3rem; }
  .screen { display: none; flex-direction: column; align-items: center; gap: 1.2rem; width: 100%; max-width: 440px; }
  .screen.active { display: flex; }
  .field {
    width: 100%; background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; color: var(--text); font-family: 'Rajdhani', sans-serif;
    font-size: 1.05rem; font-weight: 600; letter-spacing: 0.08em;
    padding: 0.85rem 1.2rem; outline: none; transition: border-color 0.2s; text-align: center;
  }
  .field:focus { border-color: var(--accent); }
  .field::placeholder { color: var(--muted); }
  .field.code { text-transform: uppercase; font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; letter-spacing: 0.25em; }
  .btn {
    width: 100%; border: none; border-radius: 10px;
    font-family: 'Bebas Neue', sans-serif; font-size: 1.35rem; letter-spacing: 0.18em;
    padding: 0.85rem 1rem; cursor: pointer; transition: opacity 0.15s, transform 0.1s;
  }
  .btn:active { transform: scale(0.98); } .btn:hover { opacity: 0.88; }
  .btn-primary { background: var(--accent); color: #000; }
  .btn-secondary { background: var(--surface); color: var(--accent); border: 1px solid var(--accent); }
  .btn-danger { background: var(--red); color: #fff; }
  .btn-ghost { background: transparent; color: var(--muted); border: 1px solid var(--border); font-size: 1rem; }
  .divider { display: flex; align-items: center; gap: 0.8rem; width: 100%; color: var(--muted); font-size: 0.75rem; letter-spacing: 0.15em; text-transform: uppercase; }
  .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
  .status { text-align: center; font-size: 0.95rem; font-weight: 600; letter-spacing: 0.05em; min-height: 1.4rem; }
  .status.err { color: var(--red); } .status.ok { color: var(--green); }
  .code-card { width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem 1.5rem; text-align: center; }
  .code-card label { font-size: 0.7rem; letter-spacing: 0.25em; color: var(--muted); text-transform: uppercase; display: block; margin-bottom: 0.4rem; }
  .big-code { font-family: 'Bebas Neue', sans-serif; font-size: 3.2rem; letter-spacing: 0.35em; color: var(--accent); }
  .slot { width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 0.9rem 1.2rem; display: flex; align-items: center; gap: 0.9rem; transition: border-color 0.3s; }
  .slot.joined { border-color: var(--green); }
  .dot { width: 9px; height: 9px; border-radius: 50%; background: var(--muted); flex-shrink: 0; transition: background 0.3s, box-shadow 0.3s; }
  .slot.joined .dot { background: var(--green); box-shadow: 0 0 8px var(--green); }
  .slot-name { flex: 1; font-weight: 700; font-size: 1rem; letter-spacing: 0.06em; }
  .you-tag { font-size: 0.65rem; letter-spacing: 0.12em; color: var(--accent); border: 1px solid var(--accent); padding: 0.15rem 0.5rem; border-radius: 4px; flex-shrink: 0; }
  .pulse { animation: pulse 1.8s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.35} }
  #gameScreen { display: none; flex-direction: column; align-items: center; width: 100%; max-width: 860px; gap: 1rem; }
  #gameScreen.active { display: flex; }
  .game-meta { color: var(--muted); font-size: 0.8rem; letter-spacing: 0.12em; margin-top: 0.2rem; text-align: center; }
  .game-meta span { color: var(--text); font-weight: 700; }
  .scoreboard { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; width: 100%; }
  .player-card { background: var(--surface); border: 2px solid var(--border); border-radius: 16px; padding: 1.4rem; position: relative; transition: border-color 0.3s, box-shadow 0.3s; }
  .player-card.active { border-color: var(--accent); box-shadow: 0 0 30px rgba(240,192,64,0.1); }
  .player-card.winner { border-color: var(--green); box-shadow: 0 0 40px rgba(61,232,138,0.2); }
  .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem; }
  .p-name { font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; letter-spacing: 0.12em; color: var(--muted); transition: color 0.3s; }
  .player-card.active .p-name { color: var(--accent); }
  .turn-icon { font-size: 1.3rem; opacity: 0; transition: opacity 0.3s; }
  .player-card.active .turn-icon { opacity: 1; }
  .p-score { font-family: 'Bebas Neue', sans-serif; font-size: clamp(4rem, 9vw, 6.5rem); line-height: 1; color: var(--text); }
  .p-avg { font-size: 0.82rem; color: var(--muted); margin-top: 0.3rem; letter-spacing: 0.05em; }
  .last-throw { display: inline-block; margin-top: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 6px; padding: 0.3rem 0.8rem; font-size: 0.95rem; font-weight: 700; letter-spacing: 0.06em; color: var(--muted); }
  .last-throw.bust { color: var(--red); border-color: var(--red); background: rgba(232,74,74,0.08); }
  .last-throw.good { color: var(--green); border-color: var(--green); background: rgba(61,232,138,0.08); }
  .input-panel { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; width: 100%; }
  .panel-title { font-size: 0.75rem; letter-spacing: 0.2em; color: var(--muted); text-transform: uppercase; margin-bottom: 1rem; }
  .panel-title em { color: var(--accent); font-style: normal; font-weight: 700; }
  .input-row { display: flex; gap: 1.2rem; align-items: flex-start; flex-wrap: wrap; }
  .score-display { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px; padding: 0.5rem 1rem; min-width: 110px; text-align: center; font-family: 'Bebas Neue', sans-serif; font-size: 3rem; letter-spacing: 0.1em; color: var(--text); min-height: 70px; display: flex; align-items: center; justify-content: center; transition: border-color 0.2s; }
  .score-display.has-val { border-color: var(--accent); color: var(--accent); }
  .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.45rem; }
  .nk { background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: 'Bebas Neue', sans-serif; font-size: 1.35rem; letter-spacing: 0.1em; padding: 0.7rem 0.5rem; cursor: pointer; transition: background 0.12s; text-align: center; }
  .nk:hover { background: rgba(255,255,255,0.09); }
  .nk.del { color: var(--red); border-color: rgba(232,74,74,0.3); background: rgba(232,74,74,0.05); }
  .nk.enter { grid-column: span 2; background: var(--accent); color: #000; border-color: var(--accent); font-size: 1.15rem; }
  .nk.enter:hover { opacity: 0.85; }
  .blocked { display: flex; align-items: center; justify-content: center; padding: 2rem; color: var(--muted); font-size: 0.95rem; letter-spacing: 0.12em; text-transform: uppercase; font-weight: 600; }
  #winOverlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(6px); z-index: 200; flex-direction: column; align-items: center; justify-content: center; gap: 1.5rem; text-align: center; padding: 2rem; }
  #winOverlay.show { display: flex; }
  .win-headline { font-family: 'Bebas Neue', sans-serif; font-size: clamp(4rem, 14vw, 9rem); color: var(--green); letter-spacing: 0.08em; line-height: 1; animation: glow 2s ease-in-out infinite alternate; }
  .win-subline { font-family: 'Bebas Neue', sans-serif; font-size: clamp(1.8rem, 5vw, 3.5rem); color: var(--accent); letter-spacing: 0.2em; }
  @keyframes glow { from { text-shadow: 0 0 20px var(--green); } to { text-shadow: 0 0 80px var(--green), 0 0 140px rgba(61,232,138,0.4); } }
  @media (max-width: 560px) { .scoreboard { grid-template-columns: 1fr; } .p-score { font-size: 5rem; } }
</style>
</head>
<body>

<div class="screen active" id="lobbyScreen">
  <div><h1 class="logo">üéØ 501 DARTS</h1><p class="tagline">Multiplayer Score Counter</p></div>
  <input class="field" id="nameInput" placeholder="Your name" maxlength="20" />
  <button class="btn btn-primary" onclick="createGame()">Create Game</button>
  <div class="divider">or join existing</div>
  <input class="field code" id="joinCodeInput" placeholder="Room Code" maxlength="6" />
  <button class="btn btn-secondary" onclick="joinGame()">Join Game</button>
  <p class="status" id="lobbyStatus"></p>
</div>

<div class="screen" id="waitingScreen">
  <div><h1 class="logo">üéØ 501 DARTS</h1><p class="tagline pulse">Waiting for opponent‚Ä¶</p></div>
  <div class="slot joined" id="slot0"><div class="dot"></div><span class="slot-name" id="slot0Name">‚Äî</span><span class="you-tag" id="slot0You" style="display:none">YOU</span></div>
  <div class="slot" id="slot1"><div class="dot"></div><span class="slot-name" id="slot1Name">Waiting‚Ä¶</span><span class="you-tag" id="slot1You" style="display:none">YOU</span></div>
  <div class="code-card"><label>Share this code with your friend</label><div class="big-code" id="waitingCode">------</div></div>
  <button class="btn btn-ghost" onclick="leaveRoom()">Leave Room</button>
</div>

<div id="gameScreen">
  <div><h1 class="logo" style="font-size:2.4rem">üéØ 501 DARTS</h1><p class="game-meta">Room: <span id="gameCode">--</span> &nbsp;‚Ä¢&nbsp; Leg: <span id="legNum">1</span></p></div>
  <div class="scoreboard">
    <div class="player-card" id="card0">
      <div class="card-header"><div class="p-name" id="pname0">Player 1</div><div class="turn-icon">üéØ</div></div>
      <div class="p-score" id="pscore0">501</div>
      <div class="p-avg" id="pavg0">Avg: ‚Äî</div>
      <div id="pthrow0"></div>
    </div>
    <div class="player-card" id="card1">
      <div class="card-header"><div class="p-name" id="pname1">Player 2</div><div class="turn-icon">üéØ</div></div>
      <div class="p-score" id="pscore1">501</div>
      <div class="p-avg" id="pavg1">Avg: ‚Äî</div>
      <div id="pthrow1"></div>
    </div>
  </div>
  <div class="input-panel" id="inputPanel">
    <div class="panel-title" id="panelTitle">Your Turn ‚Äî <em id="turnName"></em></div>
    <div id="inputArea">
      <div class="input-row">
        <div class="score-display" id="scoreDisplay">0</div>
        <div class="numpad">
          <button class="nk" onclick="numPress('1')">1</button>
          <button class="nk" onclick="numPress('2')">2</button>
          <button class="nk" onclick="numPress('3')">3</button>
          <button class="nk" onclick="numPress('4')">4</button>
          <button class="nk" onclick="numPress('5')">5</button>
          <button class="nk" onclick="numPress('6')">6</button>
          <button class="nk" onclick="numPress('7')">7</button>
          <button class="nk" onclick="numPress('8')">8</button>
          <button class="nk" onclick="numPress('9')">9</button>
          <button class="nk del" onclick="numPress('del')">‚å´</button>
          <button class="nk" onclick="numPress('0')">0</button>
          <button class="nk enter" onclick="submitScore()">ENTER ‚ñ∂</button>
        </div>
      </div>
    </div>
    <div id="blockedArea" class="blocked" style="display:none">‚è≥ Opponent's turn‚Ä¶</div>
  </div>
</div>

<div id="winOverlay">
  <div class="win-headline">CHECKOUT!</div>
  <div class="win-subline" id="winnerName"></div>
  <button class="btn btn-primary" style="max-width:280px" id="playAgainBtn">Play Again</button>
  <p id="waitingRestart" style="color:var(--muted);font-size:0.9rem;display:none">Waiting for host to restart‚Ä¶</p>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, set, get, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const app = initializeApp({ databaseURL: "https://dartcounter-dbf42-default-rtdb.firebaseio.com" });
  const db = getDatabase(app);

  let myId = null, roomCode = null, inputVal = '', unsubscribe = null;

  function genCode() { return Math.random().toString(36).substring(2,8).toUpperCase(); }
  function rRef(code) { return ref(db, `rooms/${code}`); }
  function makeRoom(name) {
    return { phase:'waiting', turn:0, leg:1, winner:null, players:{
      0:{name,score:501,lastThrow:null,totalThrown:0,totalScore:0}, 1:null
    }};
  }

  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    document.getElementById('gameScreen').classList.remove('active');
    if (id==='gameScreen') document.getElementById('gameScreen').classList.add('active');
    else document.getElementById(id).classList.add('active');
  }

  function setStatus(msg,type) {
    const el=document.getElementById('lobbyStatus');
    el.textContent=msg; el.className='status '+(type||'');
  }

  window.createGame = async function() {
    const name=document.getElementById('nameInput').value.trim()||'Player 1';
    const code=genCode();
    try {
      await set(rRef(code), makeRoom(name));
      roomCode=code; myId=0;
      document.getElementById('waitingCode').textContent=code;
      document.getElementById('slot0Name').textContent=name;
      document.getElementById('slot0You').style.display='';
      document.getElementById('slot1You').style.display='none';
      showScreen('waitingScreen');
      listenRoom(code);
    } catch(e) { setStatus('Error: '+e.message,'err'); }
  };

  window.joinGame = async function() {
    const name=document.getElementById('nameInput').value.trim()||'Player 2';
    const code=document.getElementById('joinCodeInput').value.trim().toUpperCase();
    if (!code) { setStatus('Enter a room code','err'); return; }
    try {
      const snap=await get(rRef(code));
      if (!snap.exists()) { setStatus('Room not found','err'); return; }
      const data=snap.val();
      if (data.players[1]) { setStatus('Room is full','err'); return; }
      await update(ref(db,`rooms/${code}`), {
        'players/1':{name,score:501,lastThrow:null,totalThrown:0,totalScore:0}, phase:'playing'
      });
      roomCode=code; myId=1;
      showScreen('waitingScreen');
      listenRoom(code);
    } catch(e) { setStatus('Error: '+e.message,'err'); }
  };

  window.leaveRoom = function() {
    if (unsubscribe) { unsubscribe(); unsubscribe=null; }
    roomCode=null; myId=null;
    showScreen('lobbyScreen');
  };

  function listenRoom(code) {
    if (unsubscribe) unsubscribe();
    unsubscribe = onValue(rRef(code), snap => {
      if (!snap.exists()) return;
      applyState(snap.val());
    });
  }

  function applyState(state) {
    const p0=state.players[0], p1=state.players[1];
    document.getElementById('slot0Name').textContent=p0?p0.name:'‚Äî';
    document.getElementById('slot1Name').textContent=p1?p1.name:'Waiting‚Ä¶';
    document.getElementById('slot0').className='slot'+(p0?' joined':'');
    document.getElementById('slot1').className='slot'+(p1?' joined':'');
    document.getElementById('slot0You').style.display=myId===0?'':'none';
    document.getElementById('slot1You').style.display=myId===1?'':'none';
    if (state.phase==='playing'||state.phase==='done') { showScreen('gameScreen'); renderGame(state); }
  }

  function renderGame(state) {
    document.getElementById('gameCode').textContent=roomCode;
    document.getElementById('legNum').textContent=state.leg||1;
    for (let i=0;i<2;i++) {
      const p=state.players[i]; if (!p) continue;
      const isActive=state.phase==='playing'&&state.turn==i;
      const isWinner=state.winner==i;
      document.getElementById('card'+i).className='player-card'+(isActive?' active':'')+(isWinner?' winner':'');
      document.getElementById('pname'+i).textContent=p.name+(i==myId?' (You)':'');
      document.getElementById('pscore'+i).textContent=p.score;
      const avg=p.totalThrown>0?(p.totalScore/(p.totalThrown/3)).toFixed(1):'‚Äî';
      document.getElementById('pavg'+i).textContent='Avg: '+avg;
      const throwEl=document.getElementById('pthrow'+i);
      throwEl.innerHTML=p.lastThrow!=null?`<div class="last-throw ${p.lastThrow==='BUST'?'bust':'good'}">${p.lastThrow}</div>`:'';
    }
    const isMyTurn=state.phase==='playing'&&state.turn==myId;
    const turnPlayer=state.players[state.turn];
    document.getElementById('turnName').textContent=turnPlayer?turnPlayer.name:'';
    document.getElementById('inputArea').style.display=isMyTurn?'':'none';
    document.getElementById('blockedArea').style.display=isMyTurn?'none':'';
    document.getElementById('panelTitle').style.display=isMyTurn?'':'none';
    if (state.phase==='done'&&state.winner!=null) {
      document.getElementById('winnerName').textContent=state.players[state.winner].name+' Wins!';
      document.getElementById('winOverlay').classList.add('show');
      document.getElementById('playAgainBtn').style.display=state.winner==myId?'':'none';
      document.getElementById('waitingRestart').style.display=state.winner==myId?'none':'';
    } else {
      document.getElementById('winOverlay').classList.remove('show');
    }
  }

  window.numPress = function(key) {
    if (key==='del') { inputVal=inputVal.slice(0,-1); }
    else { if (inputVal.length>=3) return; inputVal+=key; if (parseInt(inputVal)>180) inputVal='180'; }
    const d=document.getElementById('scoreDisplay');
    d.textContent=inputVal||'0'; d.className='score-display'+(inputVal?' has-val':'');
  };

  window.submitScore = async function() {
    const score=parseInt(inputVal)||0;
    inputVal='';
    const d=document.getElementById('scoreDisplay'); d.textContent='0'; d.className='score-display';
    const snap=await get(rRef(roomCode)); if (!snap.exists()) return;
    const state=snap.val();
    if (state.turn!=myId||state.phase!=='playing') return;
    const p={...state.players[myId]};
    const newScore=p.score-score;
    if (newScore<0||newScore===1) {
      p.lastThrow='BUST'; p.totalThrown=(p.totalThrown||0)+3;
    } else {
      p.score=newScore; p.lastThrow=score;
      p.totalThrown=(p.totalThrown||0)+3; p.totalScore=(p.totalScore||0)+score;
    }
    const updates={[`rooms/${roomCode}/players/${myId}`]:p};
    if (p.lastThrow!=='BUST'&&p.score===0) {
      updates[`rooms/${roomCode}/winner`]=myId; updates[`rooms/${roomCode}/phase`]='done';
    } else {
      updates[`rooms/${roomCode}/turn`]=myId==0?1:0;
    }
    await update(ref(db), updates);
  };

  document.getElementById('playAgainBtn').onclick = async function() {
    const snap=await get(rRef(roomCode)); if (!snap.exists()) return;
    const state=snap.val();
    const newTurn=state.winner!=null?(state.winner==0?1:0):0;
    const updates={
      [`rooms/${roomCode}/phase`]:'playing',
      [`rooms/${roomCode}/turn`]:newTurn,
      [`rooms/${roomCode}/winner`]:null,
      [`rooms/${roomCode}/leg`]:(state.leg||1)+1
    };
    for (let i=0;i<2;i++) if (state.players[i]) {
      updates[`rooms/${roomCode}/players/${i}/score`]=501;
      updates[`rooms/${roomCode}/players/${i}/lastThrow`]=null;
      updates[`rooms/${roomCode}/players/${i}/totalThrown`]=0;
      updates[`rooms/${roomCode}/players/${i}/totalScore`]=0;
    }
    await update(ref(db), updates);
  };

  document.addEventListener('keydown', e=>{
    if (!document.getElementById('gameScreen').classList.contains('active')) return;
    if (e.key>='0'&&e.key<='9') numPress(e.key);
    if (e.key==='Backspace') numPress('del');
    if (e.key==='Enter') submitScore();
  });
</script>
</body>
</html>
