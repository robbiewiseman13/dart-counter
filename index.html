<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>501 Dart Counter</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #080810; --surface: #10101c; --border: #1c1c30;
  --accent: #f0c040; --red: #e84a4a; --green: #3de88a;
  --text: #e8e8f2; --muted: #44445a;
}
body {
  font-family: 'Rajdhani', sans-serif;
  background: var(--bg); color: var(--text);
  min-height: 100vh; display: flex; flex-direction: column;
  align-items: center; justify-content: center; padding: 1.5rem;
  background-image: radial-gradient(ellipse 60% 50% at 15% 15%, rgba(240,192,64,0.05) 0%, transparent 100%),
                    radial-gradient(ellipse 60% 50% at 85% 85%, rgba(232,74,74,0.05) 0%, transparent 100%);
}
h1.logo { font-family: 'Bebas Neue', sans-serif; font-size: clamp(3rem,10vw,5.5rem); letter-spacing: 0.18em; color: var(--accent); line-height: 1; text-align: center; }
.tagline { text-align: center; color: var(--muted); font-size: 0.78rem; letter-spacing: 0.3em; text-transform: uppercase; margin-top: 0.3rem; }
.screen { display: none; flex-direction: column; align-items: center; gap: 1.2rem; width: 100%; max-width: 480px; }
.screen.active { display: flex; }
.field { width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-family: 'Rajdhani', sans-serif; font-size: 1.05rem; font-weight: 600; padding: 0.85rem 1.2rem; outline: none; transition: border-color 0.2s; text-align: center; }
.field:focus { border-color: var(--accent); }
.field::placeholder { color: var(--muted); }
.field.code { text-transform: uppercase; font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; letter-spacing: 0.25em; }
.btn { width: 100%; border: none; border-radius: 10px; font-family: 'Bebas Neue', sans-serif; font-size: 1.35rem; letter-spacing: 0.18em; padding: 0.85rem 1rem; cursor: pointer; transition: opacity 0.15s, transform 0.1s; }
.btn:active { transform: scale(0.98); } .btn:hover { opacity: 0.88; }
.btn-primary { background: var(--accent); color: #000; }
.btn-secondary { background: var(--surface); color: var(--accent); border: 1px solid var(--accent); }
.btn-ghost { background: transparent; color: var(--muted); border: 1px solid var(--border); font-size: 1rem; }
.divider { display: flex; align-items: center; gap: 0.8rem; width: 100%; color: var(--muted); font-size: 0.75rem; letter-spacing: 0.15em; text-transform: uppercase; }
.divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
.status { text-align: center; font-size: 0.95rem; font-weight: 600; min-height: 1.4rem; padding: 0.5rem; border-radius: 8px; }
.status.err { color: var(--red); background: rgba(232,74,74,0.1); border: 1px solid rgba(232,74,74,0.3); }
.status.ok { color: var(--green); } .status.loading { color: var(--accent); }
.code-card { width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem 1.5rem; text-align: center; }
.code-card label { font-size: 0.7rem; letter-spacing: 0.25em; color: var(--muted); text-transform: uppercase; display: block; margin-bottom: 0.4rem; }
.big-code { font-family: 'Bebas Neue', sans-serif; font-size: 3.2rem; letter-spacing: 0.35em; color: var(--accent); }
.slot { width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 0.9rem 1.2rem; display: flex; align-items: center; gap: 0.9rem; transition: border-color 0.3s; }
.slot.joined { border-color: var(--green); }
.dot { width: 9px; height: 9px; border-radius: 50%; background: var(--muted); flex-shrink: 0; }
.slot.joined .dot { background: var(--green); box-shadow: 0 0 8px var(--green); }
.slot-name { flex: 1; font-weight: 700; font-size: 1rem; }
.you-tag { font-size: 0.65rem; color: var(--accent); border: 1px solid var(--accent); padding: 0.15rem 0.5rem; border-radius: 4px; }
.pulse { animation: pulse 1.8s ease-in-out infinite; }
@keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.35} }
.legs-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.6rem; width: 100%; }
.leg-btn { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 0.1em; padding: 0.8rem 0.5rem; cursor: pointer; text-align: center; transition: all 0.15s; }
.leg-btn:hover { border-color: var(--accent); color: var(--accent); }
.leg-btn.selected { background: var(--accent); color: #000; border-color: var(--accent); }
.leg-btn span { display: block; font-family: 'Rajdhani', sans-serif; font-size: 0.7rem; font-weight: 600; margin-top: 0.1rem; opacity: 0.7; }

/* BULL SCREEN */
#bullScreen { display: none; flex-direction: column; align-items: center; gap: 1rem; width: 100%; max-width: 500px; }
#bullScreen.active { display: flex; }
.bull-instruction { text-align: center; font-size: 0.9rem; letter-spacing: 0.05em; color: var(--muted); line-height: 1.6; }
.bull-instruction em { color: var(--accent); font-style: normal; font-weight: 700; font-size: 1.1rem; }
.board-container { position: relative; width: 320px; height: 320px; border-radius: 50%; overflow: hidden; box-shadow: 0 0 40px rgba(0,0,0,0.8), 0 0 80px rgba(0,0,0,0.5); }
#dartboardSVG { width: 100%; height: 100%; display: block; }
.bull-results { width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 1rem 1.5rem; display: flex; gap: 1rem; }
.bull-player { flex: 1; text-align: center; }
.bull-player .bname { font-size: 0.75rem; letter-spacing: 0.1em; color: var(--muted); text-transform: uppercase; margin-bottom: 0.3rem; }
.bull-player .bval { font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; letter-spacing: 0.1em; color: var(--muted); }
.bull-player .bval.done { color: var(--accent); }
.bull-player .bval.waiting { color: var(--muted); font-size: 0.9rem; font-family: 'Rajdhani', sans-serif; font-style: italic; }
.bull-active-indicator { text-align: center; font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; letter-spacing: 0.15em; color: var(--accent); }

/* GAME */
#gameScreen { display: none; flex-direction: column; align-items: center; width: 100%; max-width: 900px; gap: 1rem; }
#gameScreen.active { display: flex; }
.game-meta { color: var(--muted); font-size: 0.8rem; letter-spacing: 0.12em; margin-top: 0.2rem; text-align: center; }
.game-meta span { color: var(--text); font-weight: 700; }
.match-score-bar { display: flex; justify-content: center; align-items: center; gap: 2rem; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 0.75rem 2rem; width: 100%; }
.ms-name { font-size: 0.75rem; color: var(--muted); letter-spacing: 0.1em; text-transform: uppercase; }
.ms-score { font-family: 'Bebas Neue', sans-serif; font-size: 2.2rem; color: var(--accent); letter-spacing: 0.1em; }
.ms-divider { font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; color: var(--muted); }
.ms-needed { font-size: 0.7rem; color: var(--muted); }
.scoreboard { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; width: 100%; }
.player-card { background: var(--surface); border: 2px solid var(--border); border-radius: 16px; padding: 1.4rem; transition: border-color 0.3s, box-shadow 0.3s; }
.player-card.active { border-color: var(--accent); box-shadow: 0 0 30px rgba(240,192,64,0.1); }
.player-card.winner { border-color: var(--green); box-shadow: 0 0 40px rgba(61,232,138,0.2); }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem; }
.p-name { font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; letter-spacing: 0.12em; color: var(--muted); }
.player-card.active .p-name { color: var(--accent); }
.turn-icon { font-size: 1.3rem; opacity: 0; }
.player-card.active .turn-icon { opacity: 1; }
.p-score { font-family: 'Bebas Neue', sans-serif; font-size: clamp(3.5rem,8vw,6rem); line-height: 1; color: var(--text); }
.p-avg { font-size: 0.82rem; color: var(--muted); margin-top: 0.3rem; }
.last-throw { display: inline-block; margin-top: 0.6rem; border-radius: 6px; padding: 0.3rem 0.8rem; font-size: 0.95rem; font-weight: 700; }
.last-throw.bust { color: var(--red); border: 1px solid var(--red); background: rgba(232,74,74,0.08); }
.last-throw.good { color: var(--green); border: 1px solid var(--green); background: rgba(61,232,138,0.08); }
.checkout-hint { margin-top: 0.6rem; background: rgba(240,192,64,0.08); border: 1px solid rgba(240,192,64,0.3); border-radius: 8px; padding: 0.5rem 0.8rem; }
.checkout-hint label { font-size: 0.65rem; letter-spacing: 0.15em; color: var(--accent); text-transform: uppercase; display: block; margin-bottom: 0.2rem; }
.checkout-hint .route { font-family: 'Bebas Neue', sans-serif; font-size: 1.05rem; letter-spacing: 0.06em; color: var(--text); }
.input-panel { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; width: 100%; }
.panel-title { font-size: 0.75rem; letter-spacing: 0.2em; color: var(--muted); text-transform: uppercase; margin-bottom: 1rem; }
.panel-title em { color: var(--accent); font-style: normal; font-weight: 700; }
.input-row { display: flex; gap: 1.2rem; align-items: flex-start; flex-wrap: wrap; }
.score-display { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 10px; min-width: 110px; text-align: center; font-family: 'Bebas Neue', sans-serif; font-size: 3rem; color: var(--text); min-height: 70px; display: flex; align-items: center; justify-content: center; }
.score-display.has-val { border-color: var(--accent); color: var(--accent); }
.numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.45rem; }
.nk { background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: 'Bebas Neue', sans-serif; font-size: 1.35rem; padding: 0.7rem 0.5rem; cursor: pointer; text-align: center; }
.nk:hover { background: rgba(255,255,255,0.09); }
.nk.del { color: var(--red); border-color: rgba(232,74,74,0.3); background: rgba(232,74,74,0.05); }
.nk.enter { grid-column: span 2; background: var(--accent); color: #000; border-color: var(--accent); font-size: 1.15rem; }
.nk.enter:hover { opacity: 0.85; }
.blocked { display: flex; align-items: center; justify-content: center; padding: 2rem; color: var(--muted); font-size: 0.95rem; letter-spacing: 0.12em; text-transform: uppercase; font-weight: 600; }
#winOverlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 200; flex-direction: column; align-items: center; justify-content: center; gap: 1.5rem; text-align: center; padding: 2rem; }
#winOverlay.show { display: flex; }
.win-headline { font-family: 'Bebas Neue', sans-serif; font-size: clamp(3rem,12vw,8rem); color: var(--green); letter-spacing: 0.08em; line-height: 1; animation: glow 2s ease-in-out infinite alternate; }
.win-subline { font-family: 'Bebas Neue', sans-serif; font-size: clamp(1.5rem,4vw,3rem); color: var(--accent); letter-spacing: 0.15em; }
.win-detail { color: var(--muted); font-size: 0.95rem; }
@keyframes glow { from{text-shadow:0 0 20px var(--green);}to{text-shadow:0 0 80px var(--green),0 0 120px rgba(61,232,138,0.3);} }
@media(max-width:600px){ .scoreboard{grid-template-columns:1fr;} .p-score{font-size:4.5rem;} .board-container{width:280px;height:280px;} }
</style>
</head>
<body>

<!-- LOBBY -->
<div class="screen active" id="lobbyScreen">
  <div><h1 class="logo">üéØ 501 DARTS</h1><p class="tagline">Multiplayer Score Counter</p></div>
  <input class="field" id="nameInput" placeholder="Your name" maxlength="20"/>
  <button class="btn btn-primary" id="createBtn">Create Game</button>
  <div class="divider">or join existing</div>
  <input class="field code" id="joinCodeInput" placeholder="Room Code" maxlength="6"/>
  <button class="btn btn-secondary" id="joinBtn">Join Game</button>
  <p class="status" id="lobbyStatus"></p>
</div>

<!-- LEGS SETUP -->
<div class="screen" id="legsScreen">
  <div><h1 class="logo" style="font-size:2.8rem">üéØ 501 DARTS</h1><p class="tagline">Match Setup</p></div>
  <p style="color:var(--muted);font-size:0.8rem;letter-spacing:0.15em;text-transform:uppercase">How many legs to play?</p>
  <div class="legs-grid" id="legsGrid">
    <button class="leg-btn" data-legs="1">1<span>One leg</span></button>
    <button class="leg-btn" data-legs="3">3<span>First to 2</span></button>
    <button class="leg-btn selected" data-legs="5">5<span>First to 3</span></button>
    <button class="leg-btn" data-legs="7">7<span>First to 4</span></button>
    <button class="leg-btn" data-legs="11">11<span>First to 6</span></button>
    <button class="leg-btn" data-legs="17">17<span>First to 9</span></button>
  </div>
  <button class="btn btn-primary" id="confirmLegsBtn">Confirm & Create Room</button>
  <div class="code-card"><label>Share this code with your friend</label><div class="big-code" id="legsCode">------</div></div>
  <p class="status" id="legsStatus"></p>
</div>

<!-- WAITING -->
<div class="screen" id="waitingScreen">
  <div><h1 class="logo" style="font-size:2.8rem">üéØ 501 DARTS</h1><p class="tagline pulse">Waiting for opponent‚Ä¶</p></div>
  <div class="slot joined" id="slot0"><div class="dot"></div><span class="slot-name" id="slot0Name">‚Äî</span><span class="you-tag" id="slot0You" style="display:none">YOU</span></div>
  <div class="slot" id="slot1"><div class="dot"></div><span class="slot-name" id="slot1Name">Waiting‚Ä¶</span><span class="you-tag" id="slot1You" style="display:none">YOU</span></div>
  <div class="code-card"><label>Share this code with your friend</label><div class="big-code" id="waitingCode">------</div></div>
  <button class="btn btn-ghost" id="leaveBtn">Leave</button>
</div>

<!-- BULL THROW -->
<div id="bullScreen">
  <div style="text-align:center"><h1 class="logo" style="font-size:2.4rem">üéØ NEAREST THE BULL</h1></div>
  <p class="bull-instruction">Throw a dart for bull ‚Äî closest to centre goes first<br><em id="bullThrowerName">Player 1</em>'s throw ‚Äî tap where your dart landed</p>
  <div class="board-container">
    <svg id="dartboardSVG" viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">
      <g id="boardGroup"></g>
      <g id="dartMarkers"></g>
    </svg>
  </div>
  <div class="bull-active-indicator" id="bullActiveText">Waiting for throw‚Ä¶</div>
  <div class="bull-results">
    <div class="bull-player">
      <div class="bname" id="bname0">Player 1</div>
      <div class="bval waiting" id="bval0">‚Äî</div>
    </div>
    <div style="width:1px;background:var(--border);"></div>
    <div class="bull-player">
      <div class="bname" id="bname1">Player 2</div>
      <div class="bval waiting" id="bval1">‚Äî</div>
    </div>
  </div>
</div>

<!-- GAME -->
<div id="gameScreen">
  <div style="text-align:center;width:100%">
    <h1 class="logo" style="font-size:2.2rem">üéØ 501 DARTS</h1>
    <p class="game-meta">Room: <span id="gameCode">--</span> &nbsp;‚Ä¢&nbsp; Leg <span id="legNum">1</span> of <span id="totalLegs">5</span></p>
  </div>
  <div class="match-score-bar">
    <div style="text-align:center"><div class="ms-name" id="ms0name">P1</div><div class="ms-score" id="ms0score">0</div></div>
    <div style="text-align:center"><div class="ms-divider">‚Äî</div><div class="ms-needed" id="msNeeded">First to 3</div></div>
    <div style="text-align:center"><div class="ms-name" id="ms1name">P2</div><div class="ms-score" id="ms1score">0</div></div>
  </div>
  <div class="scoreboard">
    <div class="player-card" id="card0">
      <div class="card-header"><div class="p-name" id="pname0">Player 1</div><div class="turn-icon">üéØ</div></div>
      <div class="p-score" id="pscore0">501</div>
      <div class="p-avg" id="pavg0">Avg: ‚Äî</div>
      <div id="pthrow0"></div><div id="pcheckout0"></div>
    </div>
    <div class="player-card" id="card1">
      <div class="card-header"><div class="p-name" id="pname1">Player 2</div><div class="turn-icon">üéØ</div></div>
      <div class="p-score" id="pscore1">501</div>
      <div class="p-avg" id="pavg1">Avg: ‚Äî</div>
      <div id="pthrow1"></div><div id="pcheckout1"></div>
    </div>
  </div>
  <div class="input-panel">
    <div class="panel-title" id="panelTitle">Your Turn ‚Äî <em id="turnName"></em></div>
    <div id="inputArea">
      <div class="input-row">
        <div class="score-display" id="scoreDisplay">0</div>
        <div class="numpad">
          <button class="nk" onclick="numPress('1')">1</button><button class="nk" onclick="numPress('2')">2</button><button class="nk" onclick="numPress('3')">3</button>
          <button class="nk" onclick="numPress('4')">4</button><button class="nk" onclick="numPress('5')">5</button><button class="nk" onclick="numPress('6')">6</button>
          <button class="nk" onclick="numPress('7')">7</button><button class="nk" onclick="numPress('8')">8</button><button class="nk" onclick="numPress('9')">9</button>
          <button class="nk del" onclick="numPress('del')">‚å´</button><button class="nk" onclick="numPress('0')">0</button>
          <button class="nk enter" onclick="submitScore()">ENTER ‚ñ∂</button>
        </div>
      </div>
    </div>
    <div id="blockedArea" class="blocked" style="display:none">‚è≥ <span id="blockedName">Opponent</span>'s turn‚Ä¶</div>
  </div>
</div>

<!-- WIN OVERLAY -->
<div id="winOverlay">
  <div class="win-headline" id="winHeadline">GAME SHOT!</div>
  <div class="win-subline" id="winnerName"></div>
  <div class="win-detail" id="winDetail"></div>
  <div style="display:flex;gap:1rem;flex-wrap:wrap;justify-content:center;margin-top:0.5rem">
    <button class="btn btn-primary" style="max-width:220px" id="nextLegBtn">Next Leg ‚ñ∂</button>
    <button class="btn btn-ghost" style="max-width:180px" id="winLeaveBtn">Leave</button>
  </div>
  <p id="waitingRestart" style="color:var(--muted);font-size:0.9rem;display:none">Waiting for host to start next leg‚Ä¶</p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const app = initializeApp({ databaseURL: "https://dartcounter-dbf42-default-rtdb.europe-west1.firebasedatabase.app" });
const db = getDatabase(app);

// ---- CHECKOUT TABLE ----
const CHECKOUTS = {
  170:"T20 T20 Bull",167:"T20 T19 Bull",164:"T20 T18 Bull",161:"T20 T17 Bull",
  160:"T20 T20 D20",158:"T20 T20 D19",157:"T20 T19 D20",156:"T20 T20 D18",
  155:"T20 T19 D19",154:"T20 T18 D20",153:"T20 T19 D18",152:"T20 T20 D16",
  151:"T20 T17 D20",150:"T20 T18 D18",149:"T20 T19 D16",148:"T20 T20 D14",
  147:"T20 T17 D18",146:"T20 T18 D16",145:"T20 T15 D20",144:"T20 T20 D12",
  143:"T20 T17 D16",142:"T20 T14 D20",141:"T20 T19 D12",140:"T20 T20 D10",
  139:"T20 T13 D20",138:"T20 T18 D12",137:"T20 T19 D10",136:"T20 T20 D8",
  135:"T20 T17 D12",134:"T20 T14 D16",133:"T20 T19 D8",132:"T20 T16 D12",
  131:"T20 T13 D16",130:"T20 T20 D5",129:"T20 T19 D6",128:"T20 T18 D7",
  127:"T20 T17 D8",126:"T19 T11 D12",125:"T20 T15 D10",124:"T20 T14 D11",
  123:"T20 T13 D12",122:"T18 T18 D7",121:"T20 T11 D14",120:"T20 T16 D6",
  119:"T19 T12 D8",118:"T20 T18 D2",117:"T20 T17 D3",116:"T20 T16 D4",
  115:"T20 T15 D5",114:"T20 T14 D6",113:"T20 T13 D7",112:"T20 T12 D8",
  111:"T20 T11 D9",110:"T20 T10 D10",109:"T20 T9 D11",108:"T20 T12 D6",
  107:"T19 T10 D10",106:"T20 T10 D8",105:"T20 T5 D15",104:"T20 T8 D10",
  103:"T20 T11 D5",102:"T20 T10 D6",101:"T17 T10 D10",100:"T20 D20",
  99:"T19 T6 D12",98:"T20 D19",97:"T19 D20",96:"T20 D18",95:"T19 D19",
  94:"T18 D20",93:"T19 D18",92:"T20 D16",91:"T17 D20",90:"T18 D18",
  89:"T19 D16",88:"T20 D14",87:"T17 D18",86:"T18 D16",85:"T15 D20",
  84:"T20 D12",83:"T17 D16",82:"T14 D20",81:"T19 D12",80:"T20 D10",
  79:"T13 D20",78:"T18 D12",77:"T19 D10",76:"T20 D8",75:"T17 D12",
  74:"T14 D16",73:"T19 D8",72:"T16 D12",71:"T13 D16",70:"T18 D8",
  69:"T19 D6",68:"T20 D4",67:"T17 D8",66:"T10 D18",65:"T19 D4",
  64:"T16 D8",63:"T13 D12",62:"T10 D16",61:"T15 D8",60:"20 D20",
  59:"19 D20",58:"18 D20",57:"17 D20",56:"16 D20",55:"15 D20",
  54:"14 D20",53:"13 D20",52:"12 D20",51:"11 D20",50:"Bull",
  49:"9 D20",48:"8 D20",47:"7 D20",46:"6 D20",45:"5 D20",
  44:"4 D20",43:"3 D20",42:"10 D16",41:"9 D16",40:"D20",
  39:"7 D16",38:"D19",37:"5 D16",36:"D18",35:"3 D16",34:"D17",
  33:"1 D16",32:"D16",31:"7 D12",30:"D15",29:"1 D14",28:"D14",
  27:"3 D12",26:"D13",25:"1 D12",24:"D12",23:"7 D8",22:"D11",
  21:"5 D8",20:"D10",19:"3 D8",18:"D9",17:"1 D8",16:"D8",
  15:"7 D4",14:"D7",13:"5 D4",12:"D6",11:"3 D4",10:"D5",
  9:"1 D4",8:"D4",7:"3 D2",6:"D3",5:"1 D2",4:"D2",3:"1 D1",2:"D1"
};

function ordinal(n) {
  const s=['th','st','nd','rd'],v=n%100;
  return n+(s[(v-20)%10]||s[v]||s[0]);
}

// ---- SPEECH ----
function speak(text) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  setTimeout(() => {
    const u = new SpeechSynthesisUtterance(text);
    u.rate = 0.92; u.pitch = 1.0; u.volume = 1.0;
    const voices = window.speechSynthesis.getVoices();
    const v = voices.find(v=>v.lang==='en-GB')||voices.find(v=>v.lang.startsWith('en'));
    if (v) u.voice = v;
    window.speechSynthesis.speak(u);
  }, 100);
}
if (window.speechSynthesis) {
  window.speechSynthesis.getVoices();
  window.speechSynthesis.onvoiceschanged = ()=>window.speechSynthesis.getVoices();
}

// ---- DRAW REALISTIC DARTBOARD ----
const NUMS = [20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5];
const CX=200, CY=200;
// Radii (in SVG units, viewBox 400x400)
const R = {
  boardEdge: 195,
  doubleOuter: 185,
  doubleInner: 170,
  singleOuter: 170,
  trebleOuter: 115,
  trebleInner: 100,
  singleInner: 100,
  bull25: 28,
  bullseye: 12
};

function polarToXY(angleDeg, r) {
  const rad = (angleDeg - 90) * Math.PI / 180;
  return { x: CX + r * Math.cos(rad), y: CY + r * Math.sin(rad) };
}

function arcPath(r1, r2, startDeg, endDeg) {
  const s1 = polarToXY(startDeg, r1), e1 = polarToXY(endDeg, r1);
  const s2 = polarToXY(startDeg, r2), e2 = polarToXY(endDeg, r2);
  return `M${s1.x},${s1.y} A${r1},${r1} 0 0,1 ${e1.x},${e1.y} L${e2.x},${e2.y} A${r2},${r2} 0 0,0 ${s2.x},${s2.y} Z`;
}

function drawDartboard() {
  const g = document.getElementById('boardGroup');
  g.innerHTML = '';

  // Outer black rim
  const rim = document.createElementNS('http://www.w3.org/2000/svg','circle');
  rim.setAttribute('cx',CX); rim.setAttribute('cy',CY); rim.setAttribute('r',R.boardEdge);
  rim.setAttribute('fill','#111'); g.appendChild(rim);

  // Wire circle outline
  const wire = document.createElementNS('http://www.w3.org/2000/svg','circle');
  wire.setAttribute('cx',CX); wire.setAttribute('cy',CY); wire.setAttribute('r',R.doubleOuter);
  wire.setAttribute('fill','none'); wire.setAttribute('stroke','#888'); wire.setAttribute('stroke-width','1.5');
  g.appendChild(wire);

  const segDeg = 360 / 20;

  NUMS.forEach((num, i) => {
    const startDeg = i * segDeg - segDeg / 2;
    const endDeg = startDeg + segDeg;
    const isEven = i % 2 === 0;

    // Colours
    const creamBlack = isEven ? '#f5e6c8' : '#1a1a1a';
    const redGreen = isEven ? '#c0392b' : '#1e7a3a';

    // Single outer (between trebleOuter and doubleInner)
    const pathSO = document.createElementNS('http://www.w3.org/2000/svg','path');
    pathSO.setAttribute('d', arcPath(R.doubleInner, R.trebleOuter, startDeg, endDeg));
    pathSO.setAttribute('fill', creamBlack); pathSO.setAttribute('stroke','#333'); pathSO.setAttribute('stroke-width','0.4');
    g.appendChild(pathSO);

    // Double ring
    const pathD = document.createElementNS('http://www.w3.org/2000/svg','path');
    pathD.setAttribute('d', arcPath(R.doubleOuter, R.doubleInner, startDeg, endDeg));
    pathD.setAttribute('fill', redGreen); pathD.setAttribute('stroke','#333'); pathD.setAttribute('stroke-width','0.4');
    g.appendChild(pathD);

    // Single inner (between trebleInner and bull25)
    const pathSI = document.createElementNS('http://www.w3.org/2000/svg','path');
    pathSI.setAttribute('d', arcPath(R.trebleInner, R.bull25, startDeg, endDeg));
    pathSI.setAttribute('fill', creamBlack); pathSI.setAttribute('stroke','#333'); pathSI.setAttribute('stroke-width','0.4');
    g.appendChild(pathSI);

    // Treble ring
    const pathT = document.createElementNS('http://www.w3.org/2000/svg','path');
    pathT.setAttribute('d', arcPath(R.trebleOuter, R.trebleInner, startDeg, endDeg));
    pathT.setAttribute('fill', redGreen); pathT.setAttribute('stroke','#333'); pathT.setAttribute('stroke-width','0.4');
    g.appendChild(pathT);

    // Number label
    const midDeg = startDeg + segDeg / 2;
    const lp = polarToXY(midDeg, R.doubleOuter + 8);
    const t = document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x', lp.x); t.setAttribute('y', lp.y);
    t.setAttribute('text-anchor','middle'); t.setAttribute('dominant-baseline','middle');
    t.setAttribute('fill','#ffffff'); t.setAttribute('font-size','13');
    t.setAttribute('font-family','Arial Black,Arial'); t.setAttribute('font-weight','900');
    t.textContent = num;
    g.appendChild(t);
  });

  // Wire rings
  [R.doubleOuter, R.doubleInner, R.trebleOuter, R.trebleInner].forEach(r => {
    const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
    c.setAttribute('cx',CX); c.setAttribute('cy',CY); c.setAttribute('r',r);
    c.setAttribute('fill','none'); c.setAttribute('stroke','#777'); c.setAttribute('stroke-width','1');
    g.appendChild(c);
  });

  // Wire dividers (radial lines)
  NUMS.forEach((_,i) => {
    const deg = i * segDeg - segDeg / 2;
    const inner = polarToXY(deg, R.bull25);
    const outer = polarToXY(deg, R.doubleOuter);
    const line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1',inner.x); line.setAttribute('y1',inner.y);
    line.setAttribute('x2',outer.x); line.setAttribute('y2',outer.y);
    line.setAttribute('stroke','#777'); line.setAttribute('stroke-width','0.8');
    g.appendChild(line);
  });

  // Bull 25 (green ring)
  const b25 = document.createElementNS('http://www.w3.org/2000/svg','circle');
  b25.setAttribute('cx',CX); b25.setAttribute('cy',CY); b25.setAttribute('r',R.bull25);
  b25.setAttribute('fill','#1e7a3a'); b25.setAttribute('stroke','#777'); b25.setAttribute('stroke-width','1');
  g.appendChild(b25);

  // Bullseye (red)
  const bull = document.createElementNS('http://www.w3.org/2000/svg','circle');
  bull.setAttribute('cx',CX); bull.setAttribute('cy',CY); bull.setAttribute('r',R.bullseye);
  bull.setAttribute('fill','#c0392b'); bull.setAttribute('stroke','#777'); bull.setAttribute('stroke-width','1');
  g.appendChild(bull);
}

// ---- CLICK HANDLER FOR BULL ----
function getClickDist(e, svgEl) {
  const rect = svgEl.getBoundingClientRect();
  // Handle touch events too
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  const svgX = (clientX - rect.left) / rect.width * 400;
  const svgY = (clientY - rect.top) / rect.height * 400;
  const dx = svgX - CX, dy = svgY - CY;
  const dist = Math.sqrt(dx*dx + dy*dy);
  return { dist, svgX, svgY };
}

function distLabel(dist) {
  if (dist <= R.bullseye) return 'Bullseye! (50)';
  if (dist <= R.bull25) return 'Bull (25)';
  if (dist <= R.trebleInner) return 'Single inner';
  if (dist <= R.trebleOuter) return 'Treble';
  if (dist <= R.doubleInner) return 'Single outer';
  if (dist <= R.doubleOuter) return 'Double';
  return 'Outside board';
}

// ---- STATE ----
let myId = null, roomCode = null, inputVal = '', unsubscribe = null, selectedLegs = 5;
let hasThrownBull = false; // local flag to prevent double submit

// ---- SCREEN MANAGEMENT ----
function showScreen(id) {
  ['lobbyScreen','legsScreen','waitingScreen','gameScreen'].forEach(s => {
    const el = document.getElementById(s);
    el.style.display = 'none'; el.classList.remove('active');
  });
  const bull = document.getElementById('bullScreen');
  bull.style.display = 'none'; bull.classList.remove('active');

  const el = document.getElementById(id);
  if (id === 'bullScreen') { el.style.display = 'flex'; el.classList.add('active'); }
  else if (id === 'gameScreen') { el.style.display = 'flex'; el.classList.add('active'); document.body.style.paddingTop='1.5rem'; document.body.style.justifyContent='flex-start'; return; }
  else { el.style.display = 'flex'; el.classList.add('active'); }
  document.body.style.paddingTop = '';
  document.body.style.justifyContent = 'center';
}

function showStatus(msg, type, elId='lobbyStatus') {
  const el = document.getElementById(elId);
  if (!el) return;
  el.textContent = msg; el.className = 'status '+(type||'');
}

function genCode() { return Math.random().toString(36).substring(2,8).toUpperCase(); }
function rRef(code) { return ref(db, `rooms/${code}`); }

function makeRoom(name, legs) {
  return {
    phase:'waiting', turn:0, leg:1, totalLegs:legs,
    legsWon:{'0':0,'1':0}, winner:null, matchWinner:null,
    firstThrower:0, bullPhase:0,
    bullDist:{'0':null,'1':null},
    players:{
      '0':{name,score:501,lastThrow:null,totalThrown:0,totalScore:0},
      '1':null
    }
  };
}

// ---- LEGS BUTTONS ----
document.querySelectorAll('.leg-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.leg-btn').forEach(b=>b.classList.remove('selected'));
    btn.classList.add('selected');
    selectedLegs = parseInt(btn.dataset.legs);
  });
});

// ---- CREATE ----
document.getElementById('createBtn').addEventListener('click', async () => {
  const name = document.getElementById('nameInput').value.trim() || 'Player 1';
  const code = genCode();
  showStatus('Creating‚Ä¶','loading');
  try {
    await set(rRef(code), makeRoom(name, 5));
    roomCode = code; myId = 0;
    document.getElementById('legsCode').textContent = code;
    document.getElementById('slot0Name').textContent = name;
    document.getElementById('slot0You').style.display = '';
    showScreen('legsScreen');
  } catch(e) { showStatus('Error: '+e.message,'err'); }
});

// ---- CONFIRM LEGS ----
document.getElementById('confirmLegsBtn').addEventListener('click', async () => {
  showStatus('Waiting for opponent‚Ä¶','loading','legsStatus');
  try {
    await update(rRef(roomCode), { totalLegs: selectedLegs, phase: 'waiting_player' });
    document.getElementById('waitingCode').textContent = roomCode;
    document.getElementById('slot0You').style.display = '';
    showScreen('waitingScreen');
    listenRoom(roomCode);
  } catch(e) { showStatus('Error: '+e.message,'err','legsStatus'); }
});

// ---- JOIN ----
document.getElementById('joinBtn').addEventListener('click', async () => {
  const name = document.getElementById('nameInput').value.trim() || 'Player 2';
  const code = document.getElementById('joinCodeInput').value.trim().toUpperCase();
  if (!code) { showStatus('Enter a room code','err'); return; }
  showStatus('Joining‚Ä¶','loading');
  try {
    const snap = await get(rRef(code));
    if (!snap.exists()) { showStatus('Room not found','err'); return; }
    const data = snap.val();
    if (data.players && data.players['1']) { showStatus('Room is full','err'); return; }
    await update(rRef(code), {
      'players/1': {name,score:501,lastThrow:null,totalThrown:0,totalScore:0},
      phase: 'bull'
    });
    roomCode = code; myId = 1;
    document.getElementById('waitingCode').textContent = code;
    document.getElementById('slot1You').style.display = '';
    showScreen('waitingScreen');
    listenRoom(code);
  } catch(e) { showStatus('Error: '+e.message,'err'); }
});

// ---- LEAVE ----
document.getElementById('leaveBtn').addEventListener('click', () => {
  if (unsubscribe) { unsubscribe(); unsubscribe=null; }
  roomCode=null; myId=null; hasThrownBull=false;
  showScreen('lobbyScreen');
});
document.getElementById('winLeaveBtn').addEventListener('click', () => {
  if (unsubscribe) { unsubscribe(); unsubscribe=null; }
  roomCode=null; myId=null; hasThrownBull=false;
  document.getElementById('winOverlay').classList.remove('show');
  showScreen('lobbyScreen');
});

// ---- LISTEN ----
function listenRoom(code) {
  if (unsubscribe) unsubscribe();
  unsubscribe = onValue(rRef(code), snap => {
    if (!snap.exists()) return;
    applyState(snap.val());
  }, err => console.error(err));
}

// ---- APPLY STATE ----
function applyState(state) {
  const p0=state.players['0'], p1=state.players['1'];

  // Waiting room slots
  if (document.getElementById('slot0Name')) {
    document.getElementById('slot0Name').textContent = p0?p0.name:'‚Äî';
    document.getElementById('slot1Name').textContent = p1?p1.name:'Waiting‚Ä¶';
    document.getElementById('slot0').className = 'slot'+(p0?' joined':'');
    document.getElementById('slot1').className = 'slot'+(p1?' joined':'');
  }

  if (state.phase === 'bull' && p0 && p1) {
    showBullScreen(state);
  } else if (state.phase === 'playing' || state.phase === 'leg_done' || state.phase === 'match_done') {
    showScreen('gameScreen');
    renderGame(state);
  }
}

// ---- BULL SCREEN ----
let bullClickAttached = false;

function showBullScreen(state) {
  showScreen('bullScreen');
  drawDartboard();

  const p0=state.players['0'], p1=state.players['1'];
  document.getElementById('bname0').textContent = p0.name;
  document.getElementById('bname1').textContent = p1.name;

  const bp = state.bullPhase || 0;
  const bd = state.bullDist || {'0':null,'1':null};

  // Update result display
  [0,1].forEach(i => {
    const valEl = document.getElementById('bval'+i);
    if (bd[i] !== null && bd[i] !== undefined) {
      valEl.textContent = distLabel(bd[i]);
      valEl.className = 'bval done';
    } else {
      valEl.textContent = bp==i ? 'Tap the board ‚ñº' : 'Waiting‚Ä¶';
      valEl.className = 'bval waiting';
    }
  });

  // Active indicator
  const throwerName = bp==0 ? p0.name : p1.name;
  document.getElementById('bullThrowerName').textContent = throwerName;
  document.getElementById('bullActiveText').textContent = bp < 2 ? `${throwerName} ‚Äî tap where your dart landed` : 'Deciding who goes first‚Ä¶';

  // Draw existing dart markers
  const markers = document.getElementById('dartMarkers');
  markers.innerHTML = '';
  [0,1].forEach(i => {
    if (bd[i] !== null && bd[i] !== undefined) {
      // We stored distance but not position ‚Äî draw marker at centre offset by stored dist
      // For display purposes place it roughly on the board
      const markerR = Math.min(bd[i], R.doubleOuter);
      const angle = i === 0 ? -45 : 45;
      const rad = angle * Math.PI / 180;
      const mx = CX + markerR * Math.cos(rad);
      const my = CY + markerR * Math.sin(rad);
      const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('cx',mx); c.setAttribute('cy',my); c.setAttribute('r','6');
      c.setAttribute('fill', i===0?'#f0c040':'#e84a4a');
      c.setAttribute('stroke','#fff'); c.setAttribute('stroke-width','2');
      markers.appendChild(c);
      // Line to centre
      const line = document.createElementNS('http://www.w3.org/2000/svg','line');
      line.setAttribute('x1',CX); line.setAttribute('y1',CY);
      line.setAttribute('x2',mx); line.setAttribute('y2',my);
      line.setAttribute('stroke',i===0?'rgba(240,192,64,0.3)':'rgba(232,74,74,0.3)');
      line.setAttribute('stroke-width','1'); line.setAttribute('stroke-dasharray','3,3');
      markers.insertBefore(line, c);
    }
  });

  // Attach click handler - only if it's my turn AND I haven't thrown yet
  const svg = document.getElementById('dartboardSVG');
  const isMyTurn = (bp == myId) && !hasThrownBull;

  svg.style.cursor = isMyTurn ? 'crosshair' : 'default';
  svg.style.pointerEvents = isMyTurn ? 'all' : 'none';

  if (isMyTurn && !bullClickAttached) {
    bullClickAttached = true;
    const handler = async (e) => {
      e.preventDefault();
      if (hasThrownBull) return;
      hasThrownBull = true;
      svg.style.pointerEvents = 'none';
      svg.style.cursor = 'default';
      bullClickAttached = false;
      svg.removeEventListener('click', handler);
      svg.removeEventListener('touchend', handler);
      await handleBullThrow(e);
    };
    svg.addEventListener('click', handler);
    svg.addEventListener('touchend', handler, { passive: false });
  }
}

async function handleBullThrow(e) {
  const svg = document.getElementById('dartboardSVG');
  const { dist, svgX, svgY } = getClickDist(e, svg);

  // Draw actual dart marker at click position
  const markers = document.getElementById('dartMarkers');
  const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
  c.setAttribute('cx',svgX); c.setAttribute('cy',svgY); c.setAttribute('r','6');
  c.setAttribute('fill', myId===0?'#f0c040':'#e84a4a');
  c.setAttribute('stroke','#fff'); c.setAttribute('stroke-width','2');
  markers.appendChild(c);

  const updates = {};
  updates[`rooms/${roomCode}/bullDist/${myId}`] = dist;
  const newBp = myId === 0 ? 1 : 2;
  updates[`rooms/${roomCode}/bullPhase`] = newBp;

  await update(ref(db), updates);

  // If player 1 just threw (second throw), determine winner
  if (myId === 1) {
    const snap = await get(rRef(roomCode));
    const state = snap.val();
    const bd = state.bullDist;
    if (bd['0'] !== null && bd['1'] !== null) {
      const d0 = parseFloat(bd['0']), d1 = parseFloat(bd['1']);
      const firstThrower = d0 <= d1 ? 0 : 1;
      const pName = state.players[String(firstThrower)].name;
      speak(`${pName} throws first`);
      await update(rRef(roomCode), {
        phase: 'playing',
        turn: firstThrower,
        firstThrower: firstThrower,
        bullPhase: 2
      });
    }
  }
}

// ---- RENDER GAME ----
function renderGame(state) {
  document.getElementById('gameCode').textContent = roomCode;
  document.getElementById('legNum').textContent = state.leg||1;
  document.getElementById('totalLegs').textContent = state.totalLegs||5;
  const winsNeeded = Math.ceil((state.totalLegs||5)/2);
  document.getElementById('msNeeded').textContent = `First to ${winsNeeded}`;

  const lw = state.legsWon||{'0':0,'1':0};
  document.getElementById('ms0name').textContent = state.players['0']?.name||'P1';
  document.getElementById('ms1name').textContent = state.players['1']?.name||'P2';
  document.getElementById('ms0score').textContent = lw['0']||0;
  document.getElementById('ms1score').textContent = lw['1']||0;

  for (let i=0;i<2;i++) {
    const p=state.players[String(i)]; if (!p) continue;
    const isActive=state.phase==='playing'&&state.turn==i;
    const isWinner=state.winner==i;
    document.getElementById('card'+i).className='player-card'+(isActive?' active':'')+(isWinner?' winner':'');
    document.getElementById('pname'+i).textContent=p.name+(i==myId?' (You)':'');
    document.getElementById('pscore'+i).textContent=p.score;
    const avg=p.totalThrown>0?(p.totalScore/(p.totalThrown/3)).toFixed(1):'‚Äî';
    document.getElementById('pavg'+i).textContent='Avg: '+avg;
    const te=document.getElementById('pthrow'+i);
    te.innerHTML=p.lastThrow!=null?`<div class="last-throw ${p.lastThrow==='BUST'?'bust':'good'}">${p.lastThrow==='BUST'?'BUST':p.lastThrow}</div>`:'';
    const ce=document.getElementById('pcheckout'+i);
    ce.innerHTML=(p.score<=170&&p.score>=2&&CHECKOUTS[p.score])?`<div class="checkout-hint"><label>üí° Checkout</label><div class="route">${CHECKOUTS[p.score]}</div></div>`:'';
  }

  const isMyTurn=state.phase==='playing'&&state.turn==myId;
  const tp=state.players[String(state.turn)]||{};
  document.getElementById('turnName').textContent=tp.name||'';
  document.getElementById('inputArea').style.display=isMyTurn?'':'none';
  document.getElementById('blockedArea').style.display=isMyTurn?'none':'';
  document.getElementById('panelTitle').style.display=isMyTurn?'':'none';
  document.getElementById('blockedName').textContent=tp.name||'Opponent';

  const lw2=state.legsWon||{'0':0,'1':0};

  if (state.phase==='leg_done'&&state.winner!=null) {
    const legN=state.leg||1;
    const wName=state.players[String(state.winner)]?.name||'';
    speak(`Game shot and the ${ordinal(legN)} leg`);
    document.getElementById('winHeadline').textContent='GAME SHOT!';
    document.getElementById('winnerName').textContent=wName+' wins the '+ordinal(legN)+' leg!';
    document.getElementById('winDetail').textContent=`${state.players['0']?.name} ${lw2['0']||0} ‚Äî ${lw2['1']||0} ${state.players['1']?.name}`;
    document.getElementById('winOverlay').classList.add('show');
    document.getElementById('nextLegBtn').style.display=(state.winner==myId)?'':'none';
    document.getElementById('waitingRestart').style.display=(state.winner==myId)?'none':'';
  } else if (state.phase==='match_done'&&state.matchWinner!=null) {
    const wName=state.players[String(state.matchWinner)]?.name||'';
    speak(`Game shot and the match. ${wName} wins the match!`);
    document.getElementById('winHeadline').textContent='MATCH WINNER!';
    document.getElementById('winnerName').textContent=wName;
    document.getElementById('winDetail').textContent=`Final: ${state.players['0']?.name} ${lw2['0']||0} ‚Äî ${lw2['1']||0} ${state.players['1']?.name}`;
    document.getElementById('winOverlay').classList.add('show');
    document.getElementById('nextLegBtn').style.display='none';
    document.getElementById('waitingRestart').style.display='none';
  } else {
    document.getElementById('winOverlay').classList.remove('show');
  }
}

// ---- NUMPAD ----
window.numPress = function(key) {
  if (key==='del') { inputVal=inputVal.slice(0,-1); }
  else { if (inputVal.length>=3) return; inputVal+=key; if (parseInt(inputVal)>180) inputVal='180'; }
  const d=document.getElementById('scoreDisplay');
  d.textContent=inputVal||'0'; d.className='score-display'+(inputVal?' has-val':'');
};

// ---- SUBMIT ----
window.submitScore = async function() {
  const score=parseInt(inputVal)||0;
  inputVal='';
  const d=document.getElementById('scoreDisplay'); d.textContent='0'; d.className='score-display';

  const snap=await get(rRef(roomCode)); if (!snap.exists()) return;
  const state=snap.val();
  if (state.turn!=myId||state.phase!=='playing') return;

  const p={...state.players[String(myId)]};
  const newScore=p.score-score;

  if (newScore<0||newScore===1) {
    p.lastThrow='BUST'; p.totalThrown=(p.totalThrown||0)+3;
    speak('Bust');
  } else {
    p.score=newScore; p.lastThrow=score;
    p.totalThrown=(p.totalThrown||0)+3; p.totalScore=(p.totalScore||0)+score;
    speak(String(score));
  }

  const updates={[`rooms/${roomCode}/players/${myId}`]:p};

  if (p.lastThrow!=='BUST'&&p.score===0) {
    const lw={...( state.legsWon||{'0':0,'1':0})};
    lw[String(myId)]=(parseInt(lw[String(myId)])||0)+1;
    const winsNeeded=Math.ceil((state.totalLegs||5)/2);
    updates[`rooms/${roomCode}/legsWon`]=lw;
    updates[`rooms/${roomCode}/winner`]=myId;
    if (lw[String(myId)]>=winsNeeded) {
      updates[`rooms/${roomCode}/phase`]='match_done';
      updates[`rooms/${roomCode}/matchWinner`]=myId;
    } else {
      updates[`rooms/${roomCode}/phase`]='leg_done';
    }
  } else {
    updates[`rooms/${roomCode}/turn`]=myId==0?1:0;
  }
  await update(ref(db), updates);
};

// ---- NEXT LEG ----
document.getElementById('nextLegBtn').addEventListener('click', async () => {
  const snap=await get(rRef(roomCode)); if (!snap.exists()) return;
  const state=snap.val();
  const newLeg=(state.leg||1)+1;
  const newFirst=state.firstThrower==0?1:0;
  hasThrownBull=false; bullClickAttached=false;
  await update(rRef(roomCode), {
    phase:'playing', turn:newFirst, firstThrower:newFirst,
    winner:null, leg:newLeg,
    'players/0/score':501,'players/0/lastThrow':null,
    'players/1/score':501,'players/1/lastThrow':null,
  });
  document.getElementById('winOverlay').classList.remove('show');
});

// ---- KEYBOARD ----
document.addEventListener('keydown', e=>{
  if (!document.getElementById('gameScreen').classList.contains('active')) return;
  if (e.key>='0'&&e.key<='9') numPress(e.key);
  if (e.key==='Backspace') numPress('del');
  if (e.key==='Enter') submitScore();
});

showScreen('lobbyScreen');
</script>
</body>
</html>
